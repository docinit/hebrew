<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тренажер Иврита (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&display=swap');
        .hebrew { font-family: 'Noto Sans Hebrew', sans-serif; direction: rtl; }
        #filters-container::-webkit-scrollbar { width: 4px; }
        #filters-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .active-btn { border-color: #3b82f6 !important; background-color: #eff6ff !important; color: #2563eb !important; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 border border-gray-200">
        
        <!-- 1. Экран выбора источника данных -->
        <div id="upload-screen" class="text-center py-10">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Тренажер Иврита</h1>
            <p class="text-gray-500 mb-8 text-sm">Используйте данные сайта или загрузите свой файл</p>
            
            <input type="file" id="file-input" class="hidden" accept=".json,.js,.txt">
            
            <div class="flex flex-col gap-3">
                <!-- Кнопка Начать/Продолжить с дежурным файлом -->
                <button id="btn-default-file" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-100 flex items-center justify-center gap-2" onclick="loadDefaultFile()">
                    <span id="btn-label">Начать (verbs.json)</span>
                </button>
                
                <button onclick="document.getElementById('file-input').click()" class="bg-white text-blue-600 border-2 border-blue-600 px-8 py-4 rounded-2xl font-bold hover:bg-blue-50 transition-all">
                    Загрузить свой JSON
                </button>
            </div>
            <p id="load-error" class="text-red-500 text-xs mt-4 hidden">Файл verbs.json не найден. Загрузите свой файл.</p>
        </div>

        <!-- 2. Экран настроек (Количество слов + Фильтры) -->
        <div id="settings-screen" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Настройки тренировки</h2>
            
            <div class="space-y-6">
                <!-- Количество слов (count-options) -->
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3">Количество слов</label>
                    <div id="count-options" class="grid grid-cols-4 gap-2">
                        <button onclick="setLimit(10)" class="limit-btn p-2 border-2 rounded-xl font-bold text-gray-600 border-gray-100" data-value="10">10</button>
                        <button onclick="setLimit(20)" class="limit-btn p-2 border-2 rounded-xl font-bold text-gray-600 border-gray-100" data-value="20">20</button>
                        <button onclick="setLimit(50)" class="limit-btn p-2 border-2 rounded-xl font-bold active-btn" data-value="50">50</button>
                        <button onclick="setLimit(0)" class="limit-btn p-2 border-2 rounded-xl font-bold text-gray-600 border-gray-100" data-value="0">Все</button>
                    </div>
                </div>

                <!-- Контейнер для фильтров из filterConfig -->
                <div id="filters-container" class="max-h-72 overflow-y-auto space-y-5 pr-2">
                    <!-- Заполняется функцией generateFilters -->
                </div>

                <button onclick="startQuiz()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">
                    Приступить к тесту
                </button>
            </div>
        </div>

        <!-- 3. Экран теста -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="score-display" class="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">Верно: 0</span>
                <span id="progress-display" class="text-sm font-medium text-gray-400">1 / 50</span>
            </div>

            <div class="text-center mb-8">
                <div id="question-text" class="min-h-[120px] flex items-center justify-center px-4 leading-tight"></div>
            </div>

            <div id="options-grid" class="grid gap-3 mb-8"></div>

            <div class="flex gap-2">
                <button id="repeat-audio" class="flex-1 bg-gray-100 text-gray-600 py-4 rounded-2xl font-bold hover:bg-gray-200 transition-colors flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                </button>
                <button id="next-question-btn" class="hidden flex-[3] bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                    Следующее слово
                </button>
            </div>
        </div>

        <!-- 4. Экран результата -->
        <div id="result-screen" class="hidden text-center py-6">
            <div id="result-icon-box" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Готово!</h2>
            <p id="result-summary" class="text-gray-500 mb-8"></p>
            
            <div class="bg-gray-50 rounded-3xl p-6 mb-8 grid grid-cols-2 gap-4">
                <div class="text-center">
                    <p class="text-[10px] text-gray-400 uppercase font-black mb-1">Счёт</p>
                    <p id="final-score" class="text-2xl font-bold text-gray-800"></p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] text-gray-400 uppercase font-black mb-1">Успех</p>
                    <p id="final-percent" class="text-2xl font-bold text-blue-600"></p>
                </div>
            </div>

            <button onclick="initSettings()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 mb-3 transition-all">
                Попробовать еще раз
            </button>
            <button onclick="resetToUpload()" class="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition-all">
                Загрузить другой файл
            </button>
        </div>
    </div>

    <script>
        // Состояние приложения
        let rawData = [];           
        let currentPool = [];       
        let currentIndex = 0;
        let score = 0;
        let quizLimit = 50;
        let currentItem = null;
        const filterConfig = [];

        /* Ваша конфигурация фильтров
        const filterConfig = [
            { id: 'group', label: 'Группа' },
            { id: 'binyan', label: 'Биньян' }
        ];
        */
        let activeFilters = {}; 

        // Загрузка дежурного файла
        function loadDefaultFile() {
            const btnLabel = document.getElementById('btn-label');
            const errorMsg = document.getElementById('load-error');
            
            btnLabel.innerHTML = 'Загрузка<span class="loading-dots"></span>';
            errorMsg.classList.add('hidden');

            fetch('verbs.json')
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.json();
                })
                .then(data => handleDataProcessing(data))
                .catch(() => {
                    btnLabel.textContent = 'Начать (verbs.json)';
                    errorMsg.classList.remove('hidden');
                });
        }

        // Загрузка пользовательского файла
        document.getElementById('file-input').addEventListener('change', (e) => {
            if (!e.target.files.length) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    let text = reader.result.trim();
                    // Обработка формата var data = [...]
                    if (text.includes('=')) text = text.split('=')[1].replace(/;$/, '').trim();
                    handleDataProcessing(JSON.parse(text));
                } catch(err) { alert("Ошибка: Неверный формат JSON"); }
            };
            reader.readAsText(e.target.files[0]);
        });

        // 1. Мешаем данные СРАЗУ после загрузки
        function handleDataProcessing(data) {
            rawData = [...data];
            shuffle(rawData); 
            initSettings();
        }

        function initSettings() {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('settings-screen').classList.remove('hidden');
            generateFilters();
        }

        // Ваша функция генерации фильтров
        function generateFilters() {
            const container = document.getElementById('filters-container');
            container.innerHTML = '';
            
            filterConfig.forEach(cfg => {
                // Извлекаем уникальные значения для каждого поля в filterConfig
                const values = [...new Set(rawData.map(i => i[cfg.id]).filter(Boolean))].sort();
                if (!values.length) return;

                const section = document.createElement('div');
                section.innerHTML = `
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-3">${cfg.label}</label>
                    <div class="flex flex-wrap gap-2" id="filter-group-${cfg.id}"></div>
                `;
                
                const group = section.querySelector(`#filter-group-${cfg.id}`);
                values.forEach(val => {
                    const btn = document.createElement('button');
                    const isSelected = activeFilters[cfg.id]?.includes(val);
                    
                    btn.className = `px-3 py-2 border-2 rounded-xl text-xs font-bold transition-all ${isSelected ? 'active-btn' : 'border-gray-50 text-gray-400'}`;
                    btn.textContent = val;
                    
                    btn.onclick = () => updateFilterOptions(cfg.id, val);
                    group.appendChild(btn);
                });
                container.appendChild(section);
            });
        }

        // Ваша функция обновления фильтров
        function updateFilterOptions(key, value) {
            if (!activeFilters[key]) activeFilters[key] = [];
            const index = activeFilters[key].indexOf(value);
            
            if (index > -1) activeFilters[key].splice(index, 1);
            else activeFilters[key].push(value);
            
            generateFilters(); // Перерисовываем экран настроек
        }

        function setLimit(num) {
            quizLimit = num;
            document.querySelectorAll('.limit-btn').forEach(b => {
                const bVal = parseInt(b.getAttribute('data-value'));
                if(bVal === num) b.classList.add('active-btn');
                else b.classList.remove('active-btn');
            });
        }

        function startQuiz() {
            // Применяем фильтры к уже перемешанному массиву
            let filtered = rawData.filter(item => {
                for (let key in activeFilters) {
                    if (activeFilters[key].length > 0 && !activeFilters[key].includes(item[key])) return false;
                }
                return true;
            });

            if (!filtered.length) {
                alert("Нет слов, соответствующих выбранным фильтрам!");
                return;
            }

            // Ограничиваем количество
            const finalCount = (quizLimit === 0 || quizLimit > filtered.length) ? filtered.length : quizLimit;
            currentPool = filtered.slice(0, finalCount);
            
            currentIndex = 0;
            score = 0;
            
            document.getElementById('settings-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            currentItem = currentPool[currentIndex];
            const isRuToHe = Math.random() > 0.5;
            
            document.getElementById('progress-display').textContent = `${currentIndex + 1} / ${currentPool.length}`;
            document.getElementById('score-display').textContent = `Верно: ${score}`;
            document.getElementById('next-question-btn').classList.add('hidden');

            const qEl = document.getElementById('question-text');
            qEl.textContent = isRuToHe ? currentItem.ru : currentItem.he;
            qEl.className = isRuToHe ? "text-2xl font-bold text-gray-700 text-center" : "text-5xl font-bold hebrew text-blue-900 text-center";

            const correctVal = isRuToHe ? currentItem.he : currentItem.ru;
            
            // Дистракторы (неправильные варианты)
            let distractors = rawData
                .filter(i => i.ru !== currentItem.ru)
                .slice(0, 15);
            shuffle(distractors);
            distractors = distractors.slice(0, 3).map(i => isRuToHe ? i.he : i.ru);

            let options = [correctVal, ...distractors];
            shuffle(options);

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';

            options.forEach(opt => {
                const b = document.createElement('button');
                b.className = "w-full p-4 border-2 border-gray-100 rounded-2xl text-left hover:bg-gray-50 font-bold transition-all text-gray-700";
                if(/[א-ת]/.test(opt)) b.classList.add('hebrew', 'text-2xl', 'text-right');
                b.textContent = opt;

                b.onclick = () => {
                    if(!document.getElementById('next-question-btn').classList.contains('hidden')) return;
                    
                    playHebrew(currentItem.tts || currentItem.he);
                    
                    if(opt === correctVal) {
                        b.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                        score++;
                    } else {
                        b.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                        Array.from(grid.children).forEach(child => {
                            if(child.textContent === correctVal) child.classList.add('border-green-400', 'bg-green-50');
                        });
                    }
                    document.getElementById('next-question-btn').classList.remove('hidden');
                    document.getElementById('score-display').textContent = `Верно: ${score}`;
                };
                grid.appendChild(b);
            });
        }

        // Озвучка (Проверено: ивритский голос)
        function playHebrew(text) {
            if(!text) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'he-IL';
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            const perc = Math.round((score/currentPool.length)*100);
            document.getElementById('final-score').textContent = `${score} / ${currentPool.length}`;
            document.getElementById('final-percent').textContent = `${perc}%`;
            
            const icon = document.getElementById('result-icon-box');
            const summary = document.getElementById('result-summary');
            
            if(perc >= 80) {
                icon.className = "w-20 h-20 rounded-full bg-green-100 text-green-600 flex items-center justify-center mx-auto mb-4";
                icon.innerHTML = '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
                summary.textContent = "Превосходно! Вы отлично знаете эти слова.";
            } else {
                icon.className = "w-20 h-20 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mx-auto mb-4";
                icon.innerHTML = '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                summary.textContent = "Хорошее начало, но стоит повторить еще.";
            }
        }

        function resetToUpload() {
            rawData = [];
            activeFilters = {};
            const input = document.getElementById('file-input');
            input.value = '';
            // Мгновенное открытие окна выбора
            input.click(); 
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        document.getElementById('repeat-audio').onclick = () => playHebrew(currentItem?.tts || currentItem?.he);
        document.getElementById('next-question-btn').onclick = () => {
            currentIndex++;
            if(currentIndex < currentPool.length) renderQuestion();
            else showResults();
        };
    </script>
</body>
</html>
